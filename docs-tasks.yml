version: "3"

vars:
  # Paths
  BUILD_DIR: "{{.TASKFILE_DIR}}/docs"
  DOCS_OUTPUT_DIR: "{{.BUILD_DIR}}/html"
  DOCS_VENV_DIR: "{{.TASKFILE_DIR}}/.docs-venv"
  NODE_DEPS_DIR: "{{.BUILD_DIR}}/node"

  # Other variables
  CHECKSUM_TAR_BASE_ARGS: >-
    --group=0
    --mtime='UTC 1970-01-01'
    --numeric-owner
    --owner=0
    --sort=name

tasks:
  site:
    deps: ["venv"]
    dir: "{{.TASKFILE_DIR}}/docs"
    vars:
      CHECKSUM_FILE: "{{.BUILD_DIR}}/{{.TASK}}.md5"
      OUTPUT_DIR: "{{.DOCS_OUTPUT_DIR}}"
    cmds:
      - |-
        . "{{.DOCS_VENV_DIR}}/bin/activate"
        sphinx-build \
          -a \
          -c conf \
          -b html \
          src "{{.BUILD_DIR}}/html"
      # Checksum the generated files (this command must be last)
      - |-
        cd "{{.OUTPUT_DIR}}"
        tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum > "{{.CHECKSUM_FILE}}"
    sources:
      - "conf/**/*"
      - "src/**/*"
      - "{{.TASKFILE_DIR}}/docs-tasks.yml"
    status:
      - "test -f '{{.CHECKSUM_FILE}}'"
      - >-
        diff
        <(cd '{{.OUTPUT_DIR}}' && tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum)
        "{{.CHECKSUM_FILE}}"

  serve:
    deps:
      - "http-server"
      - "site"
    cmds:
      - "npm --prefix '{{.NODE_DEPS_DIR}}' exec http-server '{{.DOCS_OUTPUT_DIR}}' -c-1"

  http-server:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.BUILD_DIR}}/{{.TASK}}.md5"
      OUTPUT_DIR: "{{.NODE_DEPS_DIR}}"
    cmds:
      - "rm -rf '{{.OUTPUT_DIR}}'"
      - "npm --prefix '{{.OUTPUT_DIR}}' install http-server"
      # Checksum the generated files (this command must be last)
      - |-
        cd "{{.OUTPUT_DIR}}"
        tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum > "{{.CHECKSUM_FILE}}"
    sources:
      - "docs-tasks.yml"
    status:
      - "test -f '{{.CHECKSUM_FILE}}'"
      - >-
        diff
        <(cd '{{.NODE_DEPS_DIR}}' && tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum)
        "{{.CHECKSUM_FILE}}"

  venv:
    internal: true
    dir: "{{.TASKFILE_DIR}}"
    vars:
      CHECKSUM_FILE: "{{.BUILD_DIR}}/{{.TASK}}.md5"
      OUTPUT_DIR: "{{.DOCS_VENV_DIR}}"
    cmds:
      - "rm -rf '{{.DOCS_VENV_DIR}}'"
      - "python3 -m venv '{{.DOCS_VENV_DIR}}'"
      # Remove calls to `hash` since Task uses `gosh` rather than `bash`.
      # NOTE: Older versions of Python's venv would only call `hash` if they detected the running
      # shell was one that had the command, but that's not the case in newer versions.
      - "sed -i 's/^\\s*hash\\s\\+.*/true/g' \"{{.DOCS_VENV_DIR}}/bin/activate\""
      - |-
        . "{{.OUTPUT_DIR}}/bin/activate"
        pip3 install --upgrade -r docs-requirements.txt
      # Checksum the generated files (this command must be last)
      - |-
        cd "{{.OUTPUT_DIR}}"
        tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum > "{{.CHECKSUM_FILE}}"
    sources:
      - "docs-requirements.txt"
      - "docs-tasks.yml"
    status:
      - "test -f '{{.CHECKSUM_FILE}}'"
      - >-
        diff
        <(cd '{{.OUTPUT_DIR}}' && tar cf - {{.CHECKSUM_TAR_BASE_ARGS}} . | md5sum)
        "{{.CHECKSUM_FILE}}"
